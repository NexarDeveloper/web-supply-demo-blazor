@page "/search"
@inherits AbstractPage
@inject NexarClient Client

<MudCard>
    <MudCardContent>
        <MudText Typo="Typo.h4" GutterBottom="true">Search</MudText>
        <MudAutocomplete T="string" Label="Query"
                         TextChanged="QueryChanged" SearchFunc="@AutocompleteAsync"
                         ResetValueOnEmptyText="true" Dense="true" CoerceText="false" />
    </MudCardContent>
    <MudCardActions>
        <MudButton Color="Color.Primary" OnClick="@SearchAsync">Search</MudButton>
        @if (_loading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
    </MudCardActions>
</MudCard>

@if (_manufacturers != null && _manufacturers.Count > 0)
{
    <MudCard>
        <MudCardContent>
            <MudTable Items="@_manufacturers">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Manufacturers</MudText>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Count</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID">@context.Id</MudTd>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Count">@context.Count</MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudCardContent>
    </MudCard>
}

@if (_parts != null && _parts.Count > 0)
{
    <MudCard>
        <MudCardContent>
            <MudTable Items="@_parts">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Parts</MudText>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh>Mpn</MudTh>
                    <MudTh>Manufacturer</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID">@context.Id</MudTd>
                    <MudTd DataLabel="Mpn">@context.Mpn</MudTd>
                    <MudTd DataLabel="Manufacturer">@context.Manufacturer</MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudCardContent>
    </MudCard>
}

@code {
    string _query;
    bool _loading;

    record CompanyInfo(string Id, string Name, int? Count);
    IReadOnlyList<CompanyInfo> _manufacturers;

    record PartInfo(string Id, string Mpn, string Manufacturer);
    IReadOnlyList<PartInfo> _parts;

    void QueryChanged(string value)
    {
        _query = value;
    }

    async Task<IEnumerable<string>> AutocompleteAsync(string value)
    {
        if (string.IsNullOrEmpty(value))
            return null;

        var res = await Client.Suggest.ExecuteAsync(value);
        if (res.Errors.Count > 0)
        {
            return null;
        }
        else
        {
            return res.Data.SupSuggest.Select(x => x.Text).ToHashSet();
        }
    }

    async Task SearchAsync()
    {
        if (string.IsNullOrWhiteSpace(_query))
            return;

        _loading = true;
        try
        {
            var res = await Client.Search.ExecuteAsync(_query);
            EnsureNoErrors(res);

            _manufacturers = res.Data.SupSearch.ManufacturerAgg
                .Select(x => new CompanyInfo(x.Company.Id, x.Company.Name, x.Count))
                .ToArray();

            _parts = res.Data.SupSearch.Results
                .Select(x => new PartInfo(x.Part.Id, x.Part.Mpn, x.Part.Manufacturer.Name))
                .ToArray();
        }
        catch (Exception ex)
        {
            await ShowErrorAsync(ex.Message);
        }
        finally
        {
            _loading = false;
        }
    }
}
